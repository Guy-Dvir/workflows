"use strict";var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}(),__assign=this&&this.__assign||Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++){b=arguments[c];for(var e in b)Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e])}return a},__awaiter=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function c(a){return function(b){return d([a,b])}}function d(c){if(e)throw new TypeError("Generator is already executing.");for(;i;)try{if(e=1,f&&(g=f[2&c[0]?"return":c[0]?"throw":"next"])&&!(g=g.call(f,c[1])).done)return g;switch(f=0,g&&(c=[0,g.value]),c[0]){case 0:case 1:g=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,f=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(g=i.trys,!(g=g.length>0&&g[g.length-1])&&(6===c[0]||2===c[0])){i=0;continue}if(3===c[0]&&(!g||c[1]>g[0]&&c[1]<g[3])){i.label=c[1];break}if(6===c[0]&&i.label<g[1]){i.label=g[1],g=c;break}if(g&&i.label<g[2]){i.label=g[2],i.ops.push(c);break}g[2]&&i.ops.pop(),i.trys.pop();continue}c=b.call(a,i)}catch(a){c=[6,a],f=0}finally{e=g=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e,f,g,h,i={label:0,sent:function(){if(1&g[0])throw g[1];return g[1]},trys:[],ops:[]};return h={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h},__rest=this&&this.__rest||function(a,b){var c={};for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&b.indexOf(d)<0&&(c[d]=a[d]);if(null!=a&&"function"==typeof Object.getOwnPropertySymbols)for(var e=0,d=Object.getOwnPropertySymbols(a);e<d.length;e++)b.indexOf(d[e])<0&&(c[d[e]]=a[d[e]]);return c},triggers;!function(a){var b=this,c=BusinessManagerAPI.ModuleId,d=BusinessManagerAPI.registerModule,e=function(a){return{headers:{Authorization:a}}},f=function(a){return{headers:{"X-Wix-Instance":a}}},g=function(a){function b(c){return a.call(this,c,{files:b.getFiles(c),module:"triggersApp",component:"triggers-bzm-app",prepare:function(){return b.prepare(c)}})||this}return __extends(b,a),b.prepare=function(a){var b=a.config.topology,c=a.instance;return axios.get("/_api/wix-laboratory-server/laboratory/conductAllInScope?scope=my-account").then(function(a){angular.module("triggersApp").config(["experimentManagerProvider",function(b){b.setExperiments(a.data)}]).constant("clientTopology",b).config(["$provide","$locationProvider","wixAngularTopologyProvider",function(a,b,d){d.setInstance(c),b.html5Mode(!0),a.decorator("$browser",["$delegate",function(a){return a.baseHref=function(){return location.pathname.substring(0,location.pathname.indexOf("triggers"))},a}])}])})},b.getFiles=function(a){var b=a.config.topology.triggersStaticsUrl,c=a.locale,d=a.debug,e=d?"concat/":"";return[[""+b+e+"scripts/bzm-modules.js",""+b+e+"scripts/scripts.js"],b+"scripts/locale/bzm-messages_"+c+".js",b+"bower_components/angular-material/angular-material.css",b+"bower_components/dashboard-ui-components/dist/styles/dashboard-ui-components-base.css",b+"bower_components/dashboard-ui-components/dist/styles/dashboard-ui-components.css",b+"styles/main.css"]},b}(AngularLazyComponent),h=function(a){function b(c){return a.call(this,c,{files:b.getFiles(),component:"send-mail-component"})||this}return __extends(b,a),b.getFiles=function(){var a=ModuleRegistry.getModule("TRIGGERS").moduleParams,b=a.config.topology.sendMailStaticsUrl,c=a.debug,d=c?"":".min";return[b+"send-mail-component.bundle"+d+".js",b+"app"+d+".css"]},b}(ReactLazyComponent),i=function(a){function b(c){return a.call(this,c,{files:b.getFiles(c),component:"smart-actions-module",resolve:function(){return ModuleRegistry.getModule("TRIGGERS").migrateActivities()}})||this}return __extends(b,a),b.getFiles=function(a){var b=a.config.topology,c=b.smartActionsStaticsUrl,d=(b.sendMailStaticsUrl,a.debug),e=d?"":".min";return[c+"smart-actions-module.bundle"+e+".js",c+"app"+e+".css"]},b}(ReactLazyComponent),j=function(a){return __awaiter(b,void 0,void 0,function(){return __generator(this,function(b){switch(b.label){case 0:return[4,ModuleRegistry.invoke("businessManager.getAppInstance",a)];case 1:return[2,b.sent()]}})})},k=function(a){return function(b){var c=b.data.forms;return c.length>0?{"form-id":{displayName:a["event.forms.formName"],displayInfo:a["event.forms.formInfo"],options:function(){return Promise.resolve(c.reduce(function(a,b){var c=b.formId,d=b.formName;return __assign({},a,(e={},e[c]=d,e));var e},{}))}}}:{}}},l=function(a){return function(b){return b.data.forms.filter(function(b){var c=b.formId;return a["form-id"]&&a["form-id"].toJSON().includes(c)}).reduce(function(a,b){var c=b.fields,d=b.formName;return a.concat(c.map(function(a){return __assign({},a,{formName:d})}))},[]).reduce(function(a,b){var c=b.formName,d=b.fieldId,e=b.fieldName;return __assign({},a,(f={},f["field:"+d]={displayName:e+" ["+c+"]",type:"string"},f));var f},{})}},m=function(a,b,c){return j(a).then(function(a){return axios.get("/_api/wix-form-builder-web/v1/published-forms?instance="+b+a,e(b+a)).then(c)}).catch(function(){return{}})},n=function(){function a(){}return a.fetchActivitiesFor=function(a,b){return __awaiter(this,void 0,void 0,function(){var c;return __generator(this,function(d){switch(d.label){case 0:return[4,axios.get(""+this.apiUrl+b+"/activities",f(a))];case 1:return c=d.sent(),[2,c.data&&c.data.data]}})})},a.translatedContactFields=function(a){var b=a.translations;return __awaiter(this,void 0,void 0,function(){var a=this;return __generator(this,function(c){return[2,Object.keys(this.contactFields).reduce(function(c,d){return __assign({},c,(e={},e[d]=__assign({},a.contactFields[d],{displayName:b[a.contactFields[d].displayName]}),e));var e},{})]})})},a.getActivityEvents=function(a){var b=a.instance,c=a.instanceId,d=a.baseUrl,e=a.locale;return __awaiter(this,void 0,void 0,function(){var a,f,g,h,i=this;return __generator(this,function(j){switch(j.label){case 0:return[4,axios.get(d+"assets/locale/messages_"+e+".json")];case 1:return a=j.sent().data,[4,this.translatedContactFields({translations:a})];case 2:return f=j.sent(),[4,this.fetchActivitiesFor(b,c)];case 3:return g=j.sent()||[],g.push("form/form/code"),[4,this.activityEvents({translations:a})];case 4:return h=j.sent(),[2,g.map(function(a){return i.activityToEvents(a,h)}).reduce(function(a,b){return a.concat(b)},[]).filter(function(a){var b=a.displayName,c=a.appDefId;return b&&c}).sort(this.byDisplayOrder).reduce(function(a,b){var c=b.eventId,d=b.appDefId,e=b.displayName,g=b.displayDescription,h=b.displayColor,i=b.activityType,j=b.conditions,k=b.providesContactInfo,n=a[d]||{events:{}};return a[d]={events:__assign({},n.events,(o={},o[c]={displayName:e,displayDescription:g,displayColor:h,removeSourceUniqueId:"form/form/code"!==c,activityType:i,conditions:j,providesContactInfo:k},o)),generateEventSchema:function(a,b){switch(a){case"form/form":return m(BusinessManagerAPI.appDefIds.wixForms,"",l(b)).then(function(a){return __assign({},a,f)});case"form/form/code":return m(d,"wixcode-dev.",l(b));default:return Promise.resolve(f)}}},a;var o},{})]}})})},a.activityEvents=function(a){var c=a.translations;return __awaiter(b,void 0,void 0,function(){var a,b,d,e,f;return __generator(this,function(g){switch(g.label){case 0:return[4,Promise.all([m(BusinessManagerAPI.appDefIds.wixForms,"",k(c)),m(BusinessManagerAPI.appDefIds.wixCode,"wixcode-dev.",k(c))])];case 1:return a=g.sent(),b=a[0],d=a[1],e=0!==Object.keys(b).length,f=0!==Object.keys(d).length,[2,__assign({},e?{"form/form":[{appDefId:BusinessManagerAPI.appDefIds.wixContactForm,displayName:"event.forms",displayDescription:"event.description.forms",displayColor:"#4eb7f5",displayOrder:0,conditions:b}]}:{},f?{"form/form/code":[{appDefId:BusinessManagerAPI.appDefIds.wixCode,eventId:"form/form/code",displayName:"event.code",displayDescription:"event.description.code",displayColor:"#4eb7f5",displayOrder:-1,providesContactInfo:!1,conditions:d}]}:{},{"contact/contact-form":[{appDefId:BusinessManagerAPI.appDefIds.wixContactForm,displayName:"event.contact_form",displayDescription:"event.description.contact_form",displayColor:"#4eb7f5",displayOrder:1}],"e_commerce/purchase":[{appDefId:BusinessManagerAPI.appDefIds.wixECommerce,displayName:"event.ecom_purchase",displayDescription:"event.description.ecom_purchase",displayColor:"#f37e63",displayOrder:2}],"contact/subscription-form":[{appDefId:BusinessManagerAPI.appDefIds.getSubscribers,displayName:"event.contact_subscribe",displayDescription:"event.description.contact_subscribe",displayColor:"#fbbd71",displayOrder:3}],"hotels/purchase":[{appDefId:BusinessManagerAPI.appDefIds.hotels,displayName:"event.hotel_purchase",displayDescription:"event.description.hotel_purchase",displayColor:"#c164bd",displayOrder:4}],"auth/login":[{appDefId:BusinessManagerAPI.appDefIds.wixSiteMembers,displayName:"event.member_login",displayDescription:"event.description.member_login",displayColor:"#84d3a0",displayOrder:5}],"auth/register":[{appDefId:BusinessManagerAPI.appDefIds.wixSiteMembers,displayName:"event.member_register",displayDescription:"event.description.member_register",displayColor:"#84d3a0",displayOrder:6,conditions:{status:{displayName:"Status",isPredefined:!0,options:function(){return Promise.resolve(["APPLICANT","ACTIVE"])}}}}],"auth/status-change":[{appDefId:BusinessManagerAPI.appDefIds.wixSiteMembers,displayName:"event.member_status_change.approved",displayDescription:"event.description.member_status_change.approved",displayColor:"green",displayOrder:8,eventId:"auth/status-change/approved",conditions:{status:{displayName:"New Status",isPredefined:!0,options:function(){return Promise.resolve(["ACTIVE"])}}}}]})]}})})},a.activityToEvents=function(a,b){return(b[a]||[]).map(function(b){return __assign({activityType:a,eventId:a},b)})},a.byDisplayOrder=function(a,b){return a.displayOrder-b.displayOrder},a.contactFields={"contact.Name.First":{displayName:"contactSchema.firstName",type:"string"},"contact.Name.Middle":{displayName:"contactSchema.middleName",type:"string"},"contact.Name.Last":{displayName:"contactSchema.lastName",type:"string"},"contact.Email[0]":{displayName:"contactSchema.firstEmail",type:"string"},"contact.Email[1]":{displayName:"contactSchema.secondEmail",type:"string"},"contact.Email[2]":{displayName:"contactSchema.thirdEmail",type:"string"},"contact.Phone[0]":{displayName:"contactSchema.firstPhone",type:"string"},"contact.Phone[1]":{displayName:"contactSchema.secondPhone",type:"string"},"contact.Phone[2]":{displayName:"contactSchema.thirdPhone",type:"string"},"contact.Address[0].Country":{displayName:"contactSchema.country",type:"string"},"contact.Address[0].Street":{displayName:"contactSchema.street",type:"string"},"contact.Address[0].City":{displayName:"contactSchema.city",type:"string"},"contact.Address[0].Zip":{displayName:"contactSchema.zip",type:"string"}},a.apiUrl="/_api/action-triggers-server/v1/",a}(),o=function(a){function b(b){var c=a.call(this,b)||this;return c.eventRegistry={},c.actionRegistry={},c.appDefId="139ef4fa-c108-8f9a-c7be-d5f492a2c939",ModuleRegistry.registerComponent("triggers",function(){return g}),ModuleRegistry.registerComponent("send-mail-lazy-component",function(){return h}),ModuleRegistry.registerComponent("smart-actions",function(){return i}),c}return __extends(b,a),b.prototype.init=function(a){this.moduleParams=a,this.registerSendMail({moduleParams:a}),this.registerInvoiceEvents()},b.prototype.migrateActivities=function(){return __awaiter(this,void 0,void 0,function(){var a,b,c,d,e,f;return __generator(this,function(g){switch(g.label){case 0:return a=this.moduleParams,b=a.instance,c=a.instanceId,d=a.locale,e=a.config.topology.smartActionsStaticsUrl,[4,n.getActivityEvents({instance:b,instanceId:c,locale:d,baseUrl:e})];case 1:return f=g.sent(),this.eventRegistry=Object.keys(f).reduce(function(a,b){var c=a[b]||{events:{}},d=f[b];return a[b]={events:__assign({},d.events,c.events),generateEventSchema:c.generateEventSchema||d.generateEventSchema},a},this.eventRegistry||{}),[2]}})})},b.prototype.registerInvoiceEvents=function(){var a=["send","pay","overdue"].reduce(function(a,b){return __assign((c={},c["invoice/"+b]={displayName:"event.invoice_"+b,displayDescription:"event.description.invoice_"+b,displayColor:"#64d4d2"},c),a);var c},{});this.register({appDefId:BusinessManagerAPI.appDefIds.invoices,events:a})},b.prototype.registerSendMail=function(a){var b=this,c=a.moduleParams,d=function(){return __awaiter(b,void 0,void 0,function(){var a,b,d;return __generator(this,function(e){switch(e.label){case 0:return a=c.locale,b=c.config.topology.sendMailStaticsUrl,[4,axios.get(b+"assets/locale/messages_"+a+".json")];case 1:return d=e.sent().data,[2,{appDefId:"b044bf47-a12d-4b6b-9e65-e384da03c745",actions:{"send-mail":{displayName:d.sendMailDisplayName,displayInfo:d.sendMailDisplayInfo,componentName:"send-mail-lazy-component"}}}]}})})}();this.register(d)},b.prototype.registerEvents=function(a){var b=a.appDefId,c=a.events,d=__rest(a,["appDefId","events"]),e=this.eventRegistry[b]||{events:{}};this.eventRegistry[b]=__assign({events:__assign({},e.events,c)},d)},b.prototype.registerActions=function(a){var b=a.appDefId,c=a.actions,d=this.actionRegistry[b]||{actions:{}};this.actionRegistry[b]={actions:__assign({},d.actions,c)}},b.prototype.register=function(a){return __awaiter(this,void 0,void 0,function(){var b,c,d,e,f;return __generator(this,function(g){switch(g.label){case 0:return[4,a];case 1:return b=g.sent(),c=b.appDefId,d=b.events,e=b.actions,f=__rest(b,["appDefId","events","actions"]),d&&this.registerEvents(__assign({appDefId:c,events:d},f)),e&&this.registerActions({appDefId:c,actions:e}),[2]}})})},b.prototype.config=function(a,b){this.register(b)},b}(BusinessManagerAPI.BusinessManagerModule);window.__IS_BUSINESS_MANAGER__=!0,d(c.Triggers,o)}(triggers||(triggers={}));